<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Messaging - Mainflux</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Messaging";
    var mkdocs_page_input_path = "messaging.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script>
  <script src="js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="index.html" class="icon icon-home"> Mainflux</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="index.html">Overview</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="provision.html">Provision</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="messaging.html">Messaging</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#http">HTTP</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mqtt">MQTT</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#coap">CoAP</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ws">WS</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#subtopics">Subtopics</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="storage.html">Storage</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="lora.html">LoRa</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="opcua.html">OPC-UA</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="edge.html">Edge</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="security.html">Security</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="cli.html">CLI</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="api.html">API</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="bootstrap.html">Bootstrap</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="twins.html">Twins</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="tracing.html">Tracing</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="dev-guide.html">Developer's Guide</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Kubernetes</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="benchmark.html">Benchmark</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Mainflux</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    
      
    
    <li>Messaging</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/mainflux/docs/edit/master/docs/messaging.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="messaging">Messaging<a class="headerlink" href="#messaging" title="Permanent link">#</a></h1>
<p>Once a channel is provisioned and thing is connected to it, it can start to
publish messages on the channel. The following sections will provide an example
of message publishing for each of the supported protocols.</p>
<h2 id="http">HTTP<a class="headerlink" href="#http" title="Permanent link">#</a></h2>
<p>To publish message over channel, thing should send following request:</p>
<pre><code>curl -s -S -i --cacert docker/ssl/certs/ca.crt -X POST -H &quot;Authorization: &lt;thing_token&gt;&quot; https://localhost/http/channels/&lt;channel_id&gt;/messages -d '[{&quot;bn&quot;:&quot;some-base-name:&quot;,&quot;bt&quot;:1.276020076001e+09, &quot;bu&quot;:&quot;A&quot;,&quot;bver&quot;:5, &quot;n&quot;:&quot;voltage&quot;,&quot;u&quot;:&quot;V&quot;,&quot;v&quot;:120.1}, {&quot;n&quot;:&quot;current&quot;,&quot;t&quot;:-5,&quot;v&quot;:1.2}, {&quot;n&quot;:&quot;current&quot;,&quot;t&quot;:-4,&quot;v&quot;:1.3}]'
</code></pre>
<p>Note that if you're going to use senml message format, you should always send
messages as an array.</p>
<p>For more information about the HTTP messaging service API, please check out the <a href="https://github.com/mainflux/mainflux/blob/master/http/openapi.yml">API documentation</a>.</p>
<h2 id="mqtt">MQTT<a class="headerlink" href="#mqtt" title="Permanent link">#</a></h2>
<p>To send and receive messages over MQTT you could use <a href="https://mosquitto.org">Mosquitto tools</a>,
or <a href="https://www.eclipse.org/paho/">Paho</a> if you want to use MQTT over WebSocket.</p>
<p>To publish message over channel, thing should call following command:</p>
<pre><code>mosquitto_pub -u &lt;thing_id&gt; -P &lt;thing_key&gt; -t channels/&lt;channel_id&gt;/messages -h localhost -m '[{&quot;bn&quot;:&quot;some-base-name:&quot;,&quot;bt&quot;:1.276020076001e+09, &quot;bu&quot;:&quot;A&quot;,&quot;bver&quot;:5, &quot;n&quot;:&quot;voltage&quot;,&quot;u&quot;:&quot;V&quot;,&quot;v&quot;:120.1}, {&quot;n&quot;:&quot;current&quot;,&quot;t&quot;:-5,&quot;v&quot;:1.2}, {&quot;n&quot;:&quot;current&quot;,&quot;t&quot;:-4,&quot;v&quot;:1.3}]'
</code></pre>
<p>To subscribe to channel, thing should call following command:</p>
<pre><code>mosquitto_sub -u &lt;thing_id&gt; -P &lt;thing_key&gt; -t channels/&lt;channel_id&gt;/messages -h localhost
</code></pre>
<p>If you want to use standard topic such as <code>channels/&lt;channel_id&gt;/messages</code> with SenML content type (JSON or CBOR), you should use following topic <code>channels/&lt;channel_id&gt;/messages</code>.</p>
<p>If you are using TLS to secure MQTT connection, add <code>--cafile docker/ssl/certs/ca.crt</code>
to every command.</p>
<h2 id="coap">CoAP<a class="headerlink" href="#coap" title="Permanent link">#</a></h2>
<p>CoAP adapter implements CoAP protocol using underlying UDP and according to <a href="https://tools.ietf.org/html/rfc7252">RFC 7252</a>. To send and receive messages over CoAP, you can use <a href="https://github.com/mkovatsc/Copper">Copper</a> CoAP user-agent. To set the add-on, please follow the installation instructions provided <a href="https://github.com/mkovatsc/Copper#how-to-integrate-the-copper-sources-into-firefox">here</a>. Once the Mozilla Firefox and Copper are ready and CoAP adapter is running locally on the default port (5683), you can navigate to the appropriate URL and start using CoAP. The URL should look like this:</p>
<pre><code>coap://localhost/channels/&lt;channel_id&gt;/messages?auth=&lt;thing_auth_key&gt;
</code></pre>
<p>To send a message, use <code>POST</code> request.
To subscribe, send <code>GET</code> request with Observe option set to 0. There are two ways to unsubscribe:
  1) Send <code>GET</code> request with Observe option set to 1.
  2) Forget the token and send <code>RST</code> message as a response to <code>CONF</code> message received by the server.</p>
<p>The most of the notifications received from the Adapter are non-confirmable. By <a href="https://tools.ietf.org/html/rfc7641#page-18">RFC 7641</a>:</p>
<blockquote>
<p>Server must send a notification in a confirmable message instead of a non-confirmable message at least every 24 hours. This prevents a client that went away or is no longer interested from remaining in the list of observers indefinitely.</p>
</blockquote>
<p>CoAP Adapter sends these notifications every 12 hours. To configure this period, please check <a href="https://www.github.com/mainflux/mainflux/tree/master/coap/README.md">adapter documentation</a> If the client is no longer interested in receiving notifications, the second scenario described above can be used to unsubscribe.</p>
<h2 id="ws">WS<a class="headerlink" href="#ws" title="Permanent link">#</a></h2>
<p>Mainflux supports <a href="https://www.hivemq.com/blog/mqtt-essentials-special-mqtt-over-websockets/#:~:text=In%20MQTT%20over%20WebSockets%2C%20the,(WebSockets%20also%20leverage%20TCP).">MQTT-over-WS</a>, rather than pure WS protocol. this bring numerous benefits for IoT applications that are derived from the properties of MQTT - like QoS and PUB/SUB features.</p>
<p>There are 2 reccomended Javascript libraries for implementing browser support for Mainflux MQTT-over-WS connectivity:</p>
<ol>
<li><a href="https://www.eclipse.org/paho/index.php?page=clients/js/index.php">Eclipse Paho JavaScript Client</a></li>
<li><a href="https://github.com/mqttjs/MQTT.js">MQTT.js</a></li>
</ol>
<p>As WS is an extension of HTTP protocol, Mainflux exposes it on port <code>80</code>, so it's usage is practically transparent.
Additionally, please notice that since same port as for HTTP is used (<code>80</code>), and extension URL <code>/mqtt</code> should be used -
i.e. connection URL should be <code>ws://&lt;host_addr&gt;/mqtt</code>.</p>
<p>For quick testing you can use <a href="http://www.hivemq.com/demos/websocket-client/">HiveMQ UI tool</a>.</p>
<p>Here is an example of a browser application connecting to Mainflux server and sending and receiving messages over WebSocket using MQTT.js library:</p>
<pre><code class="language-javascript">&lt;script src=&quot;https://unpkg.com/mqtt/dist/mqtt.min.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
    // Initialize a mqtt variable globally
    console.log(mqtt)

    // connection option
    const options = {
        clean: true, // retain session
        connectTimeout: 4000, // Timeout period
        // Authentication information
        clientId: '14d6c682-fb5a-4d28-b670-ee565ab5866c',
        username: '14d6c682-fb5a-4d28-b670-ee565ab5866c',
        password: 'ec82f341-d4b5-4c77-ae05-34877a62428f',
    }

    var channelId = '08676a76-101d-439c-b62e-d4bb3b014337'
    var topic = 'channels/' + channelId + '/messages'

    // Connect string, and specify the connection method by the protocol
    // ws Unencrypted WebSocket connection
    // wss Encrypted WebSocket connection
    const connectUrl = 'ws://localhost/mqtt'
    const client = mqtt.connect(connectUrl, options)

    client.on('reconnect', (error) =&gt; {
        console.log('reconnecting:', error)
    })

    client.on('error', (error) =&gt; {
        console.log('Connection failed:', error)
    })

    client.on('connect', function () {
        console.log('client connected:' + options.clientId)
        client.subscribe(topic, { qos: 0 })
        client.publish(topic, 'WS connection demo!', { qos: 0, retain: false })
    })

    client.on('message', function (topic, message, packet) {
        console.log('Received Message:= ' + message.toString() + '\nOn topic:= ' + topic)
    })

    client.on('close', function () {
        console.log(options.clientId + ' disconnected')
    })
&lt;/script&gt;
</code></pre>
<p><strong>N.B.</strong> Eclipse Paho lib adds sub-URL <code>/mqtt</code> automaticlly, so procedure for connecting to the server can be something like this:</p>
<pre><code class="language-javascript">var loc = { hostname: 'localhost', port: 80 }
// Create a client instance
client = new Paho.MQTT.Client(loc.hostname, Number(loc.port), &quot;clientId&quot;)
// Connect the client
client.connect({onSuccess:onConnect});
</code></pre>
<h2 id="subtopics">Subtopics<a class="headerlink" href="#subtopics" title="Permanent link">#</a></h2>
<p>In order to use subtopics and give more meaning to your pub/sub channel, you can simply add any suffix to base <code>/channels/&lt;channel_id&gt;/messages</code> topic.</p>
<p>Example subtopic publish/subscribe for bedroom temperature would be <code>channels/&lt;channel_id&gt;/messages/bedroom/temperature</code>.</p>
<p>Subtopics are generic and multilevel. You can use almost any suffix with any depth.</p>
<p>Topics with subtopics are propagated to NATS broker in the following format <code>channels.&lt;channel_id&gt;.&lt;optional_subtopic&gt;</code>.</p>
<p>Our example topic <code>channels/&lt;channel_id&gt;/messages/bedroom/temperature</code> will be translated to appropriate NATS topic <code>channels.&lt;channel_id&gt;.bedroom.temperature</code>.</p>
<p>You can use multilevel subtopics, that have multiple parts. These parts are separated by <code>.</code> or <code>/</code> separators.
When you use combination of these two, have in mind that behind the scene, <code>/</code> separator will be replaced with <code>.</code>.
Every empty part of subtopic will be removed. What this means is that subtopic <code>a///b</code> is equivalent to <code>a/b</code>.
When you want to subscribe, you can use NATS wildcards <code>*</code> and <code>&gt;</code>. Every subtopic part can have <code>*</code> or <code>&gt;</code> as it's value, but if there is any other character beside these wildcards, subtopic will be invalid. What this means is that subtopics such as <code>a.b*c.d</code> will be invalid, while <code>a.b.*.c.d</code> will be valid.</p>
<p>Authorization is done on channel level, so you only have to have access to channel in order to have access to
it's subtopics.</p>
<p><strong>Note:</strong> When using MQTT, it's recommended that you use standard MQTT wildcards <code>+</code> and <code>#</code>.</p>
<p>For more information and examples checkout <a href="https://nats.io/documentation/writing_applications/subscribing/">official nats.io documentation</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="storage.html" class="btn btn-neutral float-right" title="Storage">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="provision.html" class="btn btn-neutral" title="Provision"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright (c) Mainflux</p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/mainflux/docs/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="provision.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="storage.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme_extra.js" defer></script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
